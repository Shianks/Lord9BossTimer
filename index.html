// Update current time (GMT+8)
function updateCurrentTime() {
    const now = new Date();
    // Set to GMT+8
    const gmt8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));
    document.getElementById('current-time').textContent = 
        gmt8Time.toLocaleTimeString('en-US', { hour12: false }) + 
        ' (' + gmt8Time.toLocaleDateString() + ')';
}
setInterval(updateCurrentTime, 1000);
updateCurrentTime();

// Set current time as kill time
document.getElementById('set-current-time').addEventListener('click', function() {
    const now = new Date();
    // Convert to local datetime-local format (YYYY-MM-DDTHH:MM)
    const localDateTime = now.toISOString().slice(0, 16);
    document.getElementById('kill-time').value = localDateTime;
    updateSpawnPreview();
});

// Update spawn preview when values change
document.getElementById('kill-time').addEventListener('change', updateSpawnPreview);
document.getElementById('respawn-hours').addEventListener('input', updateSpawnPreview);
document.getElementById('respawn-minutes').addEventListener('input', updateSpawnPreview);

function updateSpawnPreview() {
    const killTimeInput = document.getElementById('kill-time').value;
    const respawnHours = parseInt(document.getElementById('respawn-hours').value) || 0;
    const respawnMinutes = parseInt(document.getElementById('respawn-minutes').value) || 0;
    
    if (killTimeInput && (respawnHours > 0 || respawnMinutes > 0)) {
        const killTime = new Date(killTimeInput);
        const totalMilliseconds = (respawnHours * 3600 + respawnMinutes * 60) * 1000;
        const spawnTime = new Date(killTime.getTime() + totalMilliseconds);
        
        document.getElementById('preview-kill-time').textContent = formatDateTime(killTime);
        document.getElementById('preview-spawn-time').textContent = formatDateTime(spawnTime);
        document.getElementById('spawn-preview').classList.remove('hidden');
    } else {
        document.getElementById('spawn-preview').classList.add('hidden');
    }
}

// Timer functionality
let activeTimers = [];

function formatTime(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

function formatShortTime(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    return `${hrs}h ${mins}m`;
}

function formatDateTime(date) {
    return date.toLocaleString('en-US', { 
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    }).replace(',', '');
}

function saveTimersToLocalStorage() {
    // Save only the bossData and endTime for each timer
    const timersToSave = activeTimers.map(timer => {
        return {
            bossData: timer.bossData,
            endTime: timer.endTime,
            active: timer.active
        };
    });
    localStorage.setItem('bossTimers', JSON.stringify(timersToSave));
}

function loadTimersFromLocalStorage() {
    const savedTimers = localStorage.getItem('bossTimers');
    if (savedTimers) {
        try {
            const timersArray = JSON.parse(savedTimers);
            timersArray.forEach(savedTimer => {
                // Recreate timer with saved data
                createTimer(savedTimer.bossData, savedTimer.endTime, savedTimer.active);
            });
        } catch (e) {
            console.error('Failed to load timers from localStorage', e);
        }
    }
}

function updateTimers() {
    const now = Date.now();
    activeTimers.forEach(timer => {
        if (timer.active) {
            const remaining = Math.floor((timer.endTime - now) / 1000);
            if (remaining <= 0) {
                timer.active = false;
                timer.countdownEl.textContent = "SPAWNED!";
                timer.countdownEl.classList.add('text-red-500', 'pulse');
                timer.timeLeftEl.textContent = "BOSS IS UP!";
                timer.timerElement.classList.add('completed');
                saveTimersToLocalStorage();
            } else {
                timer.countdownEl.textContent = formatTime(remaining);
                timer.timeLeftEl.textContent = formatShortTime(remaining) + ' until spawn';
            }
        }
    });
}

function createTimer(bossData, overrideEndTime = null, overrideActive = true) {
    const sampleTimer = document.getElementById('sample-timer');
    const newTimer = sampleTimer.cloneNode(true);
    newTimer.id = '';
    newTimer.classList.remove('hidden');
    
    // Set boss data
    newTimer.querySelector('[data-field="boss-name"]').textContent = bossData.name || 'Unknown Boss';
    newTimer.querySelector('[data-field="boss-level"]').textContent = `Lv. ${bossData.level || '?'}`;
    
    // Set status badge
    const statusEl = newTimer.querySelector('[data-field="boss-status"]');
    statusEl.textContent = bossData.status === 'confirmed' ? 'Confirmed' : 'Estimated';
    statusEl.className = `px-2 py-1 rounded text-xs ${bossData.status === 'confirmed' ? 'bg-green-700' : 'bg-yellow-700'}`;
    
    // Set respawn time
    newTimer.querySelector('[data-field="respawn-time"]').textContent = 
        `${bossData.hours}h ${bossData.minutes}m`;
    
    // Calculate times
    const killTime = new Date(bossData.killTime);
    const totalMilliseconds = (bossData.hours * 3600 + bossData.minutes * 60) * 1000;
    let spawnTime;
    if (overrideEndTime) {
        spawnTime = new Date(overrideEndTime);
    } else {
        spawnTime = new Date(killTime.getTime() + totalMilliseconds);
    }
    
    // Set time displays
    newTimer.querySelector('[data-field="kill-time"]').textContent = formatDateTime(killTime);
    newTimer.querySelector('[data-field="next-spawn"]').textContent = formatDateTime(spawnTime);
    
    // Get elements for countdown
    const countdownEl = newTimer.querySelector('[data-field="countdown"]');
    const timeLeftEl = newTimer.querySelector('[data-field="time-left"]');
    
    // Add to DOM
    document.getElementById('timers-container').prepend(newTimer);
    
    // Store timer data
    const timerObj = {
        bossData,
        countdownEl,
        timeLeftEl,
        timerElement: newTimer,
        endTime: spawnTime.getTime(),
        totalMilliseconds: totalMilliseconds,
        active: overrideActive !== undefined ? overrideActive : true
    };
    
    activeTimers.push(timerObj);
    
    // Set up boss died button
    newTimer.querySelector('.boss-died-btn').addEventListener('click', function() {
        if (confirm('Reset timer with current time as new kill time?')) {
            const newKillTime = new Date();
            const newSpawnTime = new Date(newKillTime.getTime() + timerObj.totalMilliseconds);
            
            // Update bossData killTime
            timerObj.bossData.killTime = newKillTime.toISOString();
            
            // Update displays
            newTimer.querySelector('[data-field="kill-time"]').textContent = formatDateTime(newKillTime);
            newTimer.querySelector('[data-field="next-spawn"]').textContent = formatDateTime(newSpawnTime);
            
            // Reset timer
            timerObj.endTime = newSpawnTime.getTime();
            timerObj.active = true;
            timerObj.timerElement.classList.remove('completed');
            timerObj.countdownEl.classList.remove('text-red-500', 'pulse');
            timerObj.countdownEl.classList.add('flip');
            setTimeout(() => timerObj.countdownEl.classList.remove('flip'), 500);

            saveTimersToLocalStorage();
        }
    });
    
    // Initial animation
    countdownEl.classList.add('flip');
    setTimeout(() => countdownEl.classList.remove('flip'), 500);

    saveTimersToLocalStorage();
}

// Start timer button
document.getElementById('start-timer').addEventListener('click', function() {
    const bossName = document.getElementById('boss-name').value.trim() || 'Unknown Boss';
    const bossLevel = document.getElementById('boss-level').value;
    const bossStatus = document.getElementById('boss-status').value;
    const respawnHours = parseInt(document.getElementById('respawn-hours').value) || 0;
    const respawnMinutes = parseInt(document.getElementById('respawn-minutes').value) || 0;
    const killTimeInput = document.getElementById('kill-time').value;
    
    if (!killTimeInput) {
        alert('Please enter the kill time');
        return;
    }
    
    if (respawnHours <= 0 && respawnMinutes <= 0) {
        alert('Please enter a valid respawn time');
        return;
    }
    
    // Convert kill time to Date object
    const killTime = new Date(killTimeInput);
    
    createTimer({
        name: bossName,
        level: bossLevel,
        status: bossStatus,
        hours: respawnHours,
        minutes: respawnMinutes,
        killTime: killTime.toISOString()
    });
});

// Reset form button
document.getElementById('reset-form').addEventListener('click', function() {
    document.getElementById('boss-name').value = '';
    document.getElementById('boss-level').value = '';
    document.getElementById('respawn-hours').value = '';
    document.getElementById('respawn-minutes').value = '';
    document.getElementById('kill-time').value = '';
    document.getElementById('boss-status').value = 'estimated';
    document.getElementById('spawn-preview').classList.add('hidden');
});

// Update all timers every second
setInterval(updateTimers, 1000);

// Load timers from localStorage on page load
window.addEventListener('load', () => {
    loadTimersFromLocalStorage();
});